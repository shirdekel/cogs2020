---
title: "Homework 9"
author: "Author: Matthew J. Cossley"
date: "Last update: `r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    toc: true
    toc_float:
        collapsed: true
        smooth_scroll: true
    toc_depth: 3
    fig_caption: yes
    number_sections: false
    theme: cosmo
fontsize: 14pt
---

```{r global-options, include=FALSE}
knitr::opts_chunk$set(warning=FALSE)
```

```{r setup, include=FALSE, message=F}
knitr::opts_chunk$set(echo = T, collapse=T, warning=F)
```

<style type="text/css">
  body{
  font-size: 18pt;
}

<style type="text/css">
.table {

    width: 40%;
}
</style>

```{r, echo=F}
library(data.table)
library(ggplot2)
library(ggpubr)
library(latex2exp)
```

* Create a new file named `cogs2020_hw_9.R` and save it in
the `cogs2020` folder that you created during Lecture 1.

* If you have not already installed the `data.table` and the
`ggplot2` packages, do so now. If you use the
`install.packages` function, do not include it in the script
that you hand in.

* If you have not already installed the `ez` package, do so
now. If you use the `install.packages` function, do not
include it in the script that you hand in.

* Make the first line of your script `library(data.table)`
the second line `library(ggplot2)`, and the third line
`library(ez)`.

* Make the second line of your script `rm(list=ls())`. This
line of code will erase any variable defined before it. Do
not put this line of code after anything important that you
want to keep (e.g., so that I can mark your work).

* After `rm(list=ls())`, create a variable named `my_name`
and set its value equal to a **character** vector (i.e.,
letters surrounded by `""` or by `''`) containing your name.

* After `rm(list=ls())`, create a variable named
`my_student_id` and set its value equal to a **character**
vector (i.e., letters surrounded by `""` or by `''`)
containing your student id.

* So far, here is what your file should look like if your
name is `John Doe` and and your student ID is `12345678`.
Note that the following code chunk also includes a few lines
to create a `data.table` named `d` that many of the problems
below require you manipulate.

```{r, echo=T, warning=F, message=F}
# load the packages we will need
library(data.table)
library(ggplot2)
library(ez)

# clean session
rm(list=ls())

# basic id info
my_name <- "John Doe"
my_student_id <- "12345678"

# Please include the following line of code as well
set.seed(0)
```

```{r, echo=F, message=F, warning=F}
library(data.table)
library(ggplot2)
library(ggpubr)
rm(list = ls())

gen_exp <- function(muA1, muA2, muB1, muB2, muC1, muC2, sig, n) {

  ## generate obervations
  y_A1 <- rnorm(n, muA1, sig)
  y_A2 <- rnorm(n, muA2, sig)
  y_B1 <- rnorm(n, muB1, sig)
  y_B2 <- rnorm(n, muB2, sig)
  y_C1 <- rnorm(n, muC1, sig) # new level but same mu
  y_C2 <- rnorm(n, muC2, sig) # new level but same mu

  ## store observations plus relevant indicators in data.table
  d <- data.table(y=c(y_A1, y_A2, y_B1, y_B2, y_C1, y_C2),
                  treatment=rep(c('A', 'B', 'C'), each=2*n),
                  dose=rep(c(1, 2), 3, each=n))

  d[, treatment := factor(treatment)]
  d[, dose := factor(dose)]

  ## main effect of treatment (A vs B)
  dd <- d[, .(mean(y), sd(y)/sqrt(length(unique(dose)))), .(treatment)]
  g1 <- ggplot(dd, aes(treatment, V1)) +
    geom_pointrange(aes(ymin=V1-V2, ymax=V1+V2)) +
    theme_classic() +
    theme(aspect.ratio=1) +
    ylab('Observed mean effect') +
    ggtitle('Main effect')

  ## main effect of dose (1 vs 2)
  dd <- d[, .(mean(y), sd(y)/sqrt(length(unique(treatment)))), .(dose)]
  g2 <- ggplot(dd, aes(dose, V1)) +
    geom_pointrange(aes(ymin=V1-V2, ymax=V1+V2)) +
    theme_classic() +
    theme(aspect.ratio=1) +
    ylab('Observed mean effect') +
    ggtitle('Main effect')

  ## interaction between treatment and dose
  dd <- d[, .(mean(y), sd(y)/sqrt(length(unique(treatment))*length(unique(dose)))), .(treatment, dose)]
  g3 <- ggplot(dd, aes(dose, V1, colour=treatment)) +
    geom_pointrange(aes(ymin=V1-V2, ymax=V1+V2)) +
    geom_line(aes(as.integer(dose), V1, colour=treatment)) +
    theme_classic() +
    theme(aspect.ratio=1) +
    ylab('Observed mean effect') +
    ggtitle('Interaction')

  return(list(g1, g2, g3, unique(d)))
}
```

## 1. 
Considering the following data and using an appropriate
ANOVA, test the hypothesis that there are any significant
differences between mean levels of treatment.

```{r, echo=F}
set.seed(1)
n <- 4
res <- gen_exp(10, 30, 40, 20, 40, 20, 5, n)
g1 <- res[[1]]
g2 <- res[[2]]
g3 <- res[[3]]
d <- res[[4]]
d[, dose := NULL]
d[, subject := 1:.N]
```
```{r}
# Run the following line of code to put the data into a
# data.table and proceed to work with ezANOVA from there.
d <- fread(
        "y treatment subject
 6.867731         A       1
10.918217         A       2
 5.821857         A       3
17.976404         A       4
31.647539         A       5
25.897658         A       6
32.437145         A       7
33.691624         A       8
42.878907         B       9
38.473058         B      10
47.558906         B      11
41.949216         B      12
16.893797         B      13
 8.926501         B      14
25.624655         B      15
19.775332         B      16
39.919049         C      17
44.719181         C      18
44.106106         C      19
42.969507         C      20
24.594887         C      21
23.910682         C      22
20.372825         C      23
10.053242         C      24"
)
```

Please populate the following variable:
```{r, eval=F}
ans_1 <- ezANOVA(...)
```

## 2. 
Considering the following data and using an appropriate
ANOVA, test the hypothesis that there are any significant
differences between mean levels of treatment. 

```{r, echo=F}
set.seed(1)
n <- 4
res <- gen_exp(10, 30, 40, 20, 40, 20, 5, n)
g1 <- res[[1]]
g2 <- res[[2]]
g3 <- res[[3]]
d <- res[[4]]
d[, dose := NULL]
d[, subject := rep(1:(2*n), 3)]
```
```{r}
# Run the following line of code to put the data into a
# data.table and proceed to work with ezANOVA from there.
d <- fread("
        y treatment subject
 6.867731         A       1
10.918217         A       2
 5.821857         A       3
17.976404         A       4
31.647539         A       5
25.897658         A       6
32.437145         A       7
33.691624         A       8
42.878907         B       1
38.473058         B       2
47.558906         B       3
41.949216         B       4
16.893797         B       5
 8.926501         B       6
25.624655         B       7
19.775332         B       8
39.919049         C       1
44.719181         C       2
44.106106         C       3
42.969507         C       4
24.594887         C       5
23.910682         C       6
20.372825         C       7
10.053242         C       8"
)
```

Please populate the following variable:
```{r, eval=F}
# the result of ezANOVA()
ans_2 <- ezANOVA(...)
```

## 3. 
Considering the following data and using an appropriate
ANOVA, test the hypothesis that there are any significant
differences between mean levels of treatment, mean levels of
dose, or interactions between treatment and dose. Please
populate the following variables.

```{r, echo=F}
set.seed(1)
n <- 4
res <- gen_exp(10, 30, 40, 20, 40, 20, 5, n)
g1 <- res[[1]]
g2 <- res[[2]]
g3 <- res[[3]]
d <- res[[4]]
d[, subject := rep(1:(2*n), 3)]
```
```{r}
# Run the following line of code to put the data into a
# data.table and proceed to work with ezANOVA from there.
d <- fread("
        y treatment dose subject
 6.867731         A    1       1
10.918217         A    1       2
 5.821857         A    1       3
17.976404         A    1       4
31.647539         A    2       5
25.897658         A    2       6
32.437145         A    2       7
33.691624         A    2       8
42.878907         B    1       1
38.473058         B    1       2
47.558906         B    1       3
41.949216         B    1       4
16.893797         B    2       5
 8.926501         B    2       6
25.624655         B    2       7
19.775332         B    2       8
39.919049         C    1       1
44.719181         C    1       2
44.106106         C    1       3
42.969507         C    1       4
24.594887         C    2       5
23.910682         C    2       6
20.372825         C    2       7
10.053242         C    2       8"
)
```

Please populate the following variable:
```{r, eval=F}
# the result of ezANOVA()
ans_3 <- ezANOVA(...)
```

## 4. 
Considering the following data and using an appropriate
ANOVA, test the hypothesis that there are any significant
differences between mean levels of treatment, mean levels of
dose, or interactions between treatment and dose. Please
populate the following variables.

```{r, echo=F}
set.seed(1)
n <- 4
res <- gen_exp(10, 30, 40, 20, 40, 20, 5, n)
g1 <- res[[1]]
g2 <- res[[2]]
g3 <- res[[3]]
d <- res[[4]]
d[, subject := 1:.N]
```
```{r}
# Run the following line of code to put the data into a
# data.table and proceed to work with ezANOVA from there.
d <- fread("
        y treatment dose subject
 6.867731         A    1       1
10.918217         A    1       2
 5.821857         A    1       3
17.976404         A    1       4
31.647539         A    2       5
25.897658         A    2       6
32.437145         A    2       7
33.691624         A    2       8
42.878907         B    1       9
38.473058         B    1      10
47.558906         B    1      11
41.949216         B    1      12
16.893797         B    2      13
 8.926501         B    2      14
25.624655         B    2      15
19.775332         B    2      16
39.919049         C    1      17
44.719181         C    1      18
44.106106         C    1      19
42.969507         C    1      20
24.594887         C    2      21
23.910682         C    2      22
20.372825         C    2      23
10.053242         C    2      24"
)
```

Please populate the following variable:
```{r, eval=F}
# the result of ezANOVA()
ans_4 <- ezANOVA(...)
```

## 5. 
Consider the data located here:

`https://crossley.github.io/cogs2020/data/maze/maze.csv`

This data contains the results of an experiment in which
researchers examined the effect of maze identity and run
number (experience with each maze) on maze run time in a
large sample of rats.

* `rat` contains the id of the rat that gave the data in
each row.

* `time` contains the amount of time in seconds taken to
complete the maze.

* `maze` indicates the identity of the maze.

* `run` indicates the run number.

Using an appropriate ANOVA, assess any significant
differences between runs. If you have multiple observations
per rat, per run, then be sure to average over these values
such that you end up with only one (mean) observation per
rat per run.

Pleaes populate the following variable:

```{r, eval=F}
ans_5 <- ezANOVA(...)
```

## 6. 
Consider the following sampling distributions of two $F$
test statistics. One of these sampling distributions
corresponds to a repeated measures design, while the other
corresponds to a factorial design. The observed value of the
F test statistic (indicated by the dashed lines) is 1.5 in
both cases.

```{r, echo=F, fig.width=10}
set.seed(7)

n_total <- 24
n <- 8
k <- 3

f_obs <- 1.5

# repeated
df_between <- k-1
df_error <- (k-1) * (n-1)
# pf(f_obs, df_between, df_error, lower.tail=F)

x <- seq(0, 4, 0.001)
fx <- df(x, df_between, df_error)
d <- data.table(x, fx)
g1 <- ggplot(d, aes(x, fx)) + 
  geom_line() +
  geom_vline(xintercept = f_obs, linetype=2) +
  scale_x_continuous(breaks=c(0, f_obs, 1, 2, 3, 4)) +
  geom_ribbon(data=d[x >= f_obs], aes(ymin=0, ymax=fx), alpha=0.25) +
  annotate("text", x = 1.6, y = 0.1, hjust = 0, label = "Area of shaded region = 0.26") 

# factorial
df_between <- k-1
df_error <- n_total - k
# pf(f_obs, df_between, df_error, lower.tail=F)

x <- seq(0, 4, 0.001)
fx <- df(x, df_between, df_error)
d <- data.table(x, fx)
g2 <- ggplot(d, aes(x, fx)) + 
  geom_line() +
  geom_vline(xintercept = f_obs, linetype=2) +
  scale_x_continuous(breaks=c(0, f_obs, 1, 2, 3, 4)) +
  geom_ribbon(data=d[x >= f_obs], aes(ymin=0, ymax=fx), alpha=0.25) +
  annotate("text", x = 1.6, y = 0.1, hjust = 0, label = "Area of shaded region = 0.25")

ggarrange(g1, g2, ncol=2)

ggsave('./img/quiz9_1.png', g2)
```

* Which distribution corresponds to the repeated measures
design, and which to the factorial design?
  * `ans_6a <- "repeated on the left, factorial on the right"` 
  * `ans_6a <- "factorial on the left, repeated on the right"` 
  
* What is the p-value of the test corresponding the left
distribution? Please store your answer in a variable named
`ans_6b`.